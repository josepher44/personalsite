<!doctype html>

<html>
    <head>
        <meta charset="utf-8">
        <meta name="keywords" content="Engineering, Mechanical, Aerospace, Manufacturing, Robotics, Mechanical Engineer, Robotics Engineer, Portfolio, Boston">
        <meta name="description" content="Joe Gallagher's Engineering Portfolio">

        <title>Fixing Entropy</title>
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.6.3/css/all.css" integrity="sha384-UHRtZLI+pbxtHCWp1t77Bi1L4ZtiqrqD80Kn4Z8NTSRyMA2Fd33n5dQ8lWUE00s/" crossorigin="anonymous">


        <link rel="stylesheet" href="layout.css">

    </head>

    <body>
        <div class="popupmask" onclick="hidePopups()"></div>

        <div id="sidebar-container">
            <div id="sidebar">

            </div>

        </div>

        <div id="collageButton">

        </div>
        <div id="banner">
            <div id="gridcontainer">
                <div id="grid">

                                        <div class="column">
                    <img src="/images/collage/croppedauger.jpg"><img src="/images/collage/matlab1.jpg">
                        <img src="/images/collage/Catapult1.jpg">

                        <img src="/images/collage/labview1.jpg">
                        <img src="/images/collage/dynamite1.jpg">
                        <img class="bannerimg" src="/images/collage/epiphanyflight1.jpg">

                    </div>
                    <div class="column">
                        <img src="/images/collage/enables.png">
                        <img src="/images/collage/bond.png">
                        <img src="/images/collage/epiphanybuild1.jpg">
                        
                        <img src="/images/collage/opencv.png">
                        <img class="bannerimg" src="/images/collage/kinematics1.jpg">

                    </div>
                    <div class="column">

                        <img src="/images/collage/miscmatlab.png">
                        <img src="/images/collage/savagesoccer1.jpg">
                        <img src="/images/collage/osciliscreen1.jpg">
                        <img src="/images/collage/FluxRing1.jpg">
                        <img class="bannerimg" src="/images/collage/Reverted1.jpg">


                    </div>
                    <div class="column">

                        <img src="/images/collage/2015FRC4.jpg">

                        <img src="/images/collage/ineviball.jpg">
                        <img src="/images/collage/Camgear.jpg">
                        <img src="/images/collage/2015FRC9.jpg">
                        <img class="bannerimg" src="/images/collage/ES3323-1.jpg">

                    </div> 
                    <div class="column">
                        <img src="/images/collage/shootergearbox1.jpg">
                        
                        <img src="/images/collage/polar.png">
                        <img src="/images/collage/Savage2.jpg">
                        <img src="/images/collage/Epiphanyebay1.jpg">
                        <img src="/images/collage/Moose2.jpg">

                        <img class="bannerimg" src="/images/collage/smad1.jpg">
                    </div>
                    <div class="column">

                        <img src="/images/collage/2012FRC1.jpg">
                        <img src="/images/collage/panel1.jpg">
                        <img src="/images/collage/link1.jpg">

                        <img src="/images/collage/astar1.jpg">
                        <img src="/images/collage/interstage.png">
                        <img class="bannerimg" src="/images/collage/9barrender1.jpg">


                    </div>
                    <div class="column">
                       
                        <img src="/images/collage/softeng1.jpg">
                        <img src="/images/collage/medusa.png">
                        <img src="/images/collage/Bridgeport1.jpg">
                        <img src="/images/collage/sailorpeg1.jpg">
                        <img class="bannerimg" src="/images/collage/Sortedlego1.jpg">

                    </div>                                
                    <div class="column">
                        <img src="/images/collage/matlab2.jpg"><img src="/images/collage/funkymonkey1.jpg">
                        <img src="/images/collage/kidspeedy1.jpg">
                        <img src="/images/collage/dynacam.jpg">
                        <img class="bannerimg" src="/images/collage/2015FRC6.jpg">

                    </div>
                </div>
            </div>
        </div>
        <div id="about">


        </div>




        <div id="content-wrapper">

            <div id="content">

                <h1>Anonymizing BLCrawler, for Fun and RAM Consumption!</h1>

                <p><em>Feel free to skip most of this part if you know all about Tor and networking, or just don’t want to cringe as I learn about these things through horridly hacky experimentation. </em></p>

                <p><em>The intent of this piece is to show the process, failures, and rationales behind the project, as well as documenting lessons learned in one place, both to allow others to clearly follow my workflow, and also to provide myself the opportunity to make sense of lessons learned by forcing myself to make it make sense to others, particularly by explicitly covering tricky concepts I got hung up on, and the way of looking at them which helped them “click” for me. The last thing I want to do is to give the impression I just automatically knew how to do all this, because the opposite is true – all of my best lessons come from getting my hands dirty, diving into things I know full well are over my head, getting confused, making mistakes, and realizing all the ways in which what I’ve been building is suboptimal as I learn more along the way. I’ve learned a ton from similar pieces which get into the ugly behind-the-scenes rather than just presenting a polished finished product, and hope to help pay it forwards by alleviating the frustration I found in uncovering some of this information, but that does mean from time to time, I’ll divert from “description of the new thing I made” towards “description of something well-established I had to learn about in order to get back to making that new thing,” or towards “This is bad and I feel bad about it, but this is the way it works right now, because I wasn’t as smart when I made it yesterday.”</em></p>

                <p>Anyways, Tor. Tor is an encrypted proxy network of sorts. Rather than taking the most direct route through the infamous series of tubes , Tor bounces your server requests around a series of nodes under a layer of encryption, which is gradually stripped away as your data approaches the connection, referred to as a “circuit.” On the server side, your data appears to be originating from one of several hundred exit nodes, chosen at random from volunteers who use their computers or servers to support the network. You may have heard of Tor in the context of those who take advantage of its anonymity to share illicit material or solicit nefarious services, but its primary stated goal is actually to provide net freedom to citizens of countries where government censorship of the internet is prevalent. It’s actually predominantly funded by the US government for this purpose! Nevertheless, it’s attracted a wide userbase, ranging from journalists protecting their identities, to communication during protests and rebellions around the world, to mostly regular people who are slightly more worried than average about Zuckerberg and the NSA reading their emails, to “internet-survivalists” whose primary activity in life is worrying about the activities of Zuckerberg and the NSA. </p>

                <p>None of those really describe me. In this case, I am mostly interested in the fact that you can request a connection to a new Tor circuit with a click of a button. Unlike a conventional VPN or proxy server, which would anonymize a user by hiding them behind a single, unchanging IP address and identity, a Tor connection can be cycled over to a new identity at any given moment. The idea here is, a bunch of requests which systematically access the entire catalog over a 24 hour period sticks out rather badly in a server log if it comes from one IP address, whether it’s the one associated with my home network or not. A bunch of requests from a bunch of different IP addresses looks more like normal traffic, even if those requests just happen to comprehensively cover the entire catalog. </p>

                <p><em>I’m not building a DDOS attack I swear I just really wish Bricklink would update their TOS to reflect the almost certain reality of their modern day server capacity ok? </em></p>

                <p><em>Because replace “Tor exit nodes” with “unwitting computers compromised by viruses,” turn up the request rate a thousand times, and…yeah that’s how DDOS attacks work. BL Admins if you’re reading this I swear I’m trying my best to be as kind as practical to your servers.</em></p>

                <p>Now, when you start doing research on the Tor network, you are reading works written by, on average, <strong><em>extremely paranoid people, who assume that your application is life and death and that if I mess up one bit the LEGO-Gestapo are going to bust down my door and drag me away.</em></strong> This isn’t an actual concern – the most likely outcome to being noticed by Bricklink is their server sending an automated “hey, could you, like, not?” message, worst case is getting my account banned. Still, the curious subculture of people extremely concerned with keeping their pictures of cats private kind of runs the show when it comes to technical documentation of the Tor network, and as such, a lot of documentation isn’t so much “documentation,” as it is dire warnings. The key theme is that no technology is 100% secure, and that a hostile government or <a class="popup" onclick="popup1()">super dedicated sysadmin<span class="popuptext" id="popup1"><img class="popupimg" src="https://imgs.xkcd.com/comics/devotion_to_duty.png"></span></a>  can use all kinds of crazy things like your screen size to identify you if you do something silly like dare to maximize your browser window, and that you should really be taking all of these other precautions and installing all these other tools, and you really should learn to live without javascript, and… </p>

                <p>Wasn’t this project about LEGO at one point? I’ll get back there, I swear. </p>

                <p>
                    …And then they warn that by blocking and hiding everything about yourself you’re going to appear as the odd one out compared to everyone just using outdated Chrome installs so what you should really be doing is looking as generic as possible rather than simply hiding things, and that any tool you install for privacy could itself be a source of vulnerabilities through which you could be killed, or worse, expelled, or worst of all, have your own IP address exposed. And that maybe this whole “internet” thing was a <a class="popup" onclick="popup5()">bad idea after all.<span class="popuptext" id="popup5"><iframe width="560" height="315" src="https://www.youtube.com/embed/nJVW_DqLntg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></span></a>
                </p>

                <p>It’s exhausting. I couldn’t be a person who worries about these things every single day. Zuckerberg can keep my browser history. </p>

                <p>Still, reading about all this was enlightening. I knew virtually nothing of the behind the scenes of how the internet and computer networks really work before this project. While I made the decision that my use case was low enough risk that I didn’t need to go all-out in anonymizing my activity, there are several smaller features, and one pretty large one, which I implemented beyond routing my traffic through the Tor network.</p>

                <p>Most notably, I learned how little I actually knew about how HTTP requests work and what a server actually sees when you send a request, and to what extent my program as written was waving a giant flag reading “Hi! I’m an automated program using JSoup, not a real person!" The more correct response would have been to say “so, maybe, start learning those things,” but instead I decided to take a quick and dirty approach to making my scraping look a lot more human-ish. </p>

                <p>Moving away from JSoup, I re-implemented the webscraping code by grossly mispurposing the <a href="https://www.seleniumhq.org/">Selenium Webdriver</a>. Selenium is a browser automation tool, which through means I sorta-but-don’t-quite-fully understand, takes control of an instance of a standard web browser like Chrome or Firefox, and allows total control of the browser from your software. Well beyond simple source HTML scraping, Selenium allows you to perform much more sophisticated actions with the site, filling out forms, clicking buttons, and so on. It is intended to be used predominantly by web developers for unit testing purposes, but it also provides means of accessing/parsing the underlying HTML, and the advantage of doing so through what for all intents and purposes is a standard web browser, which will look like a standard web browser on the server side. </p>

                <p>Another, less-good reason to use a webdriver for scraping was that a browser was, to my knowledge at the time, the only means of actually accessing the Tor network. Tor access is most commonly gained through use of the Tor Browser, a super-modded version of Firefox which uses the Tor network by default and contains a bunch of built in features and restrictions to prevent unwitting users from revealing their identity. Like this: </p>

                <div class="pageimgcontainer"><img class="pageimg" src="/images/screensize.png"></div>

                <p>See? Told you the things which can apparently be treated as security threats can come from crazy-obscure, borderline nonsensical places. Still, because it wasn’t that hard, I added a quick block of code to randomize the window size when Selenium launches the browser. Little things can make a difference.</p>

                <p>Onto more regrettable design choices and cool information about how the internet actually works! Turns out, the people who made Selenium didn’t exactly have Tor in mind – they provide implementations for Chrome, Firefox, and so on, but nothing more obscure. So the question then becomes, can you configure something more mainstream to talk with the internet using Tor as well? My readings made clear that there is a distinction between the Tor network and the Tor browser – the browser is just a means of accessing the network, but it seems then that another browser should be able to do the same?</p>

                <p>
                    Turns out you can, and it’s pretty easy. To understand how this works, we need to learn a bit about the concept of network ports. This is the “how I explain it to myself” version – it’s quick, dirty, probably very incomplete, possibly wrong or misleading, but it works.
                </p>

                <p>A device connected to the internet receives a tremendous amount of data, piped to its unique IP address. The specific form of this data is something I remain blissfully unaware of (I know something called “TCP” gets involved), but at its core, its going to be just bits – 1s and 0s. There are probably some standard formats and headers involved, but the bulk of it is going to be raw data, which could take on any form, and I mean any form. I could write a program which communicates with other devices on the network by piping raw animated GIFs of <a class="popup" onclick="popup15()">bees performing waggle dances<span class="popuptext" id="popup15"><iframe width="560" height="315" src="https://www.youtube.com/embed/-7ijI-g4jHg" frameborder="0" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></span></a> down an ethernet cable, and as long as the receiving device knows to expect the GIF file format, and I have enough time on my hands to teach it to interpret the language of bee-moshpits, then this will work perfectly fine.</p>

                <p>Language and any form of communication are artificial constructs, which can be anything we want them to be, as long as we form agreement on how it’s going to work. Don’t believe me? Try learning to create logical program using the magic of 1980s power ballad lyrics. <a href="https://github.com/dylanbeattie/rockstar">This is a thing some people agreed we should be able to do, and now you can</a>. Seriously, read the language specification document, it's excellent. "Poetic literals allow the programmer to simultaneously initialize a variable and express their innermost angst." 
                </p>


                <p>God are internet rabbit holes a wonderful place.</p>

                <p>But if I pointed this data at something more conventional like a web browser, it’s going to go “wait wtf what even is this, like where is my &lt;html&gt; opening tag I’m expecting this is gibberish to me.” There’s no reason to expect data configured for one piece of software to universally make sense to another. </p>

                <p>Even if we agree to use a standard format of some sort, there are still problems. What if I toss a webpage at my computer, and I have 10 tabs open in chrome? Each tab knows how to read data just fine. How do I indicate where this data is meant to go?</p>
                <p>The solution to both problems is to use network ports. Network ports are virtual &ndash; despite the name, they don&rsquo;t correspond to physical plugs. But they function in a similar way. Each process which uses the network will be assigned a port, numbered from 1 to 65536. Every process which uses the network has a port number assigned to it. Ports can &ldquo;listen&rdquo; for traffic targeted at them, or they can &ldquo;connect&rdquo; to other ports either locally or remotely, such that communication between a pair of ports is permanently linked. Incoming traffic has a port number associated with it, so that it is automatically piped to a service which will be able to actually make sense of the information.</p>
                <p>For example, here&rsquo;s the port forwarding setup screen on my home router. On my local network, my home server is at address 192.168.1.200, while the router is 192.168.1.1. All unsolicited incoming network traffic hits the router first. Most of this is nonsense, and doesn&rsquo;t go any further. However, I have specific services running on the server meant to handle requests made by convention to these five ports.</p>
                <p>The server, in turn, is continuously running services which listen for requests over ports 21, 22, 80, 443, and 4040 &ndash; an Apache webserver, a FTP server, and so on. Because I&rsquo;ve told the router this information, incoming traffic which requests to be routed over each of these ports will be passed on to the server, where it will connect to the relevant port and a running service which can make actual use of the incoming information.</p>

                <div class="pageimgcontainer"><img class="pageimg" src="/images/portforward.png"></div>

                <p>Tor has two port numbers associated with it. One port is used for communications with the outside world. Data sent over this port is encrypted/packaged to bounce around the Tor network to its destination, data is received in the form of more standard HTTP request responses over the same port. The second port is used for internal connections. This port listens for data being sent to it from other applications, and works via something called the SOCKS protocol. Normally, a browser will open its own arbitrary ports to connect to the internet. But by instructing it to access the network via a specific port, in this case Tor&rsquo;s SOCKS port, Firefox communicates its requests to the local Tor application instead of the internet at large. Tor, in turn, generates enhanced versions of these requests with instructions to bounce around the Tor network, and passes the results back to Firefox, which is none the wiser about the wild journey its simple HTTP requests went on by virtue of being virtually plugged into a slightly different hole in the wall than it usually is.</p>
                <p>Looking through the actual port data, it&rsquo;s a bit more complex than this, as both firefox and tor bounce requests around a couple of different locally connected ports both controlled by the same application. But here&rsquo;s the basics of how it works, showing the ports which connect the five basic elements of the system:</p>


                <div class="pageimgcontainer"><img class="pageimg" src="/images/torflow.png"></div>

                <p>I think that&rsquo;s how this all works, at least. If this is right, cool. If it&rsquo;s wrong, well, I trust that <a href="https://meta.wikimedia.org/wiki/Cunningham%27s_Law" target="_blank">Cunningham&rsquo;s law</a> will get back to me eventually.</p>
                <p>Anyways, the point is, Firefox has a nifty little tool in it, where you can direct it to connect to the internet by talking to another application using the SOCKS protocol, instead of directly. Under Options/Network Settings, you just set a manual connection via a SOCKS host on the local machine (127.0.0.1, always), and give it the port number you&rsquo;ve set up Tor, or any such application, to listen on for SOCKS connections.</p>


                <div class="pageimgcontainer"><img class="pageimg" src="/images/ffsocks.png"></div>



                <div class="pageimgcontainer"><img class="pageimg" src="/images/ffproxy.png"></div>

                <p>You can see how Firefox, connected to the internet over Tor, reports a different IP address (that of the exit node being used), than Chrome, which is simply connected directly to the internet. Firefox is also being launched and controlled by Selenium, via only a couple lines of code here:</p>

                <div class="codeblock">

                    <p class="code">

                        <span class="keyword">public</span> String getURL(String <span class="param">url</span>, int <span class="param">id</span>)<br>
                        {<br></p>
                    <p class="code" style="margin-left: 40px"><span class="varname">delayQueueMap</span>.get(<span class="param">id</span>).getSelenium().gotoURL(<span class="param">url</span>);<br>
                        <span class="keyword">return</span> <span class="varname">delayQueueMap</span>.get(<span class="param">id</span>).getSelenium().getHTML();<br></p>
                    <p class="code">}

                    </p>
                </div>

                <p>Success!</p>

                <p>Note that this is all a VERY messy solution, and it’s about to get exponentially more so. I am certain there is a way to open a connection to the Tor network without launching a full fledged browser. I am certain that there is a way to launch multiple Tor circuits on separate network ports (a problem I’ll be facing shortly), which does not involve duplicating the entire package with changes to one configuration file. I am certain that there is a way to pipe an automatically generated HTTP request through the Tor network, and to satisfactorily approximate the appearance of a browser while doing so. I did none of these things, and am now paying the price. Adding this functionality to the program now adds some hefty RAM-eating applications operating in the background: Firefox and the Tor browser (which is essentially Firefox+). This starts as a problem, and becomes a bigger problem. A solution which removes these requirements would be much nicer.</p>

                <p>In fact, I forget what lead me to believe this wasn’t possible before, 

                    <a href="https://stackoverflow.com/questions/52395005/how-to-use-the-tor-browser-as-web-driver-selenium" target="_blank">let me check and-</a></p>

                <p>Oh god damnit. It’s really that easy?</p>

                <p>But then I’m still using the browser, <a href="https://stackoverflow.com/questions/29653758/how-to-use-tor-combine-with-java" target="_blank">unless-</a></p>

                <p>WAT. WHERE WAS THIS AND WHY DID I NEVER SEE IT?</p>

                <p>2016 Joe had real lousy Google-fu, didn’t he? I will maintain that that’s the #1 most important software development skill. </p>

                <p>Anyways, this particular aspect of the code definitely falls under &ldquo;ugly but it works,&rdquo; and given the amount of aspects which fall under &ldquo;ugly and it doesn&rsquo;t work and I don&rsquo;t understand it god please help,&rdquo; it may stay there for a while, so let&rsquo;s dig into how these ideas are actually implemented, and why in practice it gets <em>even uglier, yet somehow still works.</em></p>
                <p>(This is one of the times when I really like software: A virtual tower held together with duct tape still mostly usually holds itself together, and can be considered &ldquo;working.&rdquo; An actual tower held together with duct tape usually falls over if you blow on it wrong, and is considered &ldquo;terribly designed.&rdquo; That&rsquo;s probably a terrible reason to like software, isn&rsquo;t it?)</p>
                <p>The reason Firefox is being used over Chrome or another option here is the profile system used by Firefox. These profiles contain different user settings and defaults (such as the proxy settings used to link Firefox to Tor), and can be chosen at startup manually, or automatically by the Selenium Java library. This is immediately a convenience (you can have a normal profile for normal browsing), and will quickly become functionally vital.</p>



                <div class="pageimgcontainer"><img class="pageimg" src="/images/ffprofile.png"></div>

                <p>The initial implementation was quite straightforward. SeleniumModule was a static class, initialized at startup. It would launch Tor and, using Selenium, Firefox. Firefox started with a user profile tied to Tor and with a number of recommended privacy-hardening settings in place. A series of user commands were built, each corresponding to a relevant type of page on the Bricklink website. Each would call the getURL method of the Selenium model, which accessed the URL and returned the raw page HTML in string format, where is could then be parsed for relevant data. For the time, this data was simply saved to a text file, with further manipulation developed later. To perform a scrape, a top level command would read the valid part list and generate the thousands of URLs to be scraped, and queue up a corresponding command. The list order and command delays were both randomized, again to mask the “systematic” nature of the operation. The queue process outlined above would step through the commands, calling each sequentially, eventually reaching every relevant page on the Bricklink site. </p>


                <div class="pageimgcontainer"><img class="pageimg" src="/images/console2.png"></div>

                <div class="pageimgcontainer"><img class="pageimg" src="/images/console3.png"></div>

                <p>It wasn&rsquo;t very effective. A downside of Tor is that it&rsquo;s a bit on the slow side, so with the added randomized delays, a full scrape would take a manageable, but still non-ideal, time period (~2 days). More worringly, I discovered that Tor doesn&rsquo;t reconnect to different circuits if it is in use continuously. This meant that the entire scrape operation was still being performed on one IP, just not my own. Better, but still far from ideal &ndash; I want my requests to come from <em>a bunch</em> of IPs, so they better approximate standard traffic.</p>
                <p>The Tor browser has tools to force a circuit reset, but I couldn&rsquo;t access these via Selenium. So instead I just hard-relaunched Tor. This was surprisingly difficult to do effectively. Turns out that when you launch a program from Java, it just kind of launches and floats away. It doesn&rsquo;t become a Java object, or provide you any means of tracking &ldquo;Hey, that one, that program over there, that&rsquo;s <em>mine</em>.&rdquo; So you have to resort to pretty crude means of shutting it down, like searching windows for all running programs which match the name &ldquo;firefox.exe&rdquo; or &ldquo;Tor.exe,&rdquo; and indiscriminately mowing them all down. This was done on a loop ever 75 or so command executions.</p>
                <p>This, unsurprisingly, made things safer, but dramatically slower. Tor is kind of slow to operate, but it&rsquo;s <em>excruciatingly</em> slow to start. This implementation was now approaching 50% downtime, where half the time was spent just waiting around rather than loading websites. Not okay. So the next logical idea was, why have ONE browser, when you can have MANY? Launching several instances of Tor and Firefox together, each pair working on a separate Tor circuit, would greatly improve the situation. One could be restarting, while the others kept chugging away scraping. Overall request rate would go up as well &ndash; each individual IP would be issuing requests at a much lower rate than the system as a whole. Sounds simple enough, but it forced a near total structural rewrite of the entire program. So much so, that there was about a year&rsquo;s pause in progress around this point as I got discouraged and began to work on other things.</p>
                <p>A key lesson from this project: <em>If you build a software module or other aspect of a system, under the assumption that it&rsquo;s going to be a one-off, make SURE it&rsquo;s going to be a one-off, or else you&rsquo;re going to make a whole bunch of choices that are very hard to undo when you inevitably decide you need to duplicate it. </em>Ever have a program refuse to start and tell you &ldquo;CrappyFreeware.exe is already running,&rdquo; and you go &ldquo;BUT YOU&rsquo;RE NOT RUNNING I&rsquo;VE FORCE-QUIT YOU FROM THE TASK MANAGER 70 TIMES, WHY CAN&rsquo;T YOU JUST RUN TWICE LIKE HOW HARD CAN THAT BE?&rdquo; I&rsquo;m a lot more sympathetic to that issue now.</p>
                <p>In this case, the issues were the static classes used for the queue implementation, and the selenium module. Both needed heavy rewrites in order to become instantiable. Queues work a little differently now. Instead of serving the program as a whole, Queues are now firmly associated with a given Selenium module. Tasks are queued up for this specific module, via a master &ldquo;Selenium Distrubutor,&rdquo; which serves as the parent class to all selenium models. The Selenium Distributor handles tracking the actions of the system as a whole, and ensuring that the net result of all individual module actions adds up to the complete operation being performed, while doing its best to load-balance the individual Selenium modules.</p>

                <div class="pageimgcontainer"><img class="pageimg" src="/images/seleniumdistro.png"></div>

                <p>In practice, this actually ended up being quite challenging, in large part due to quirks in how Tor works. You see, that thing I mentioned about how certain programs don&rsquo;t like being launched multiple times? Yeah, turns out Tor is one of those. And the reason, actually, has to do with its use of network ports. Tor uses ports 9050 and 9150 by default, so that applications can easily be hard-coded to communicate via Tor. It doesn&rsquo;t have the capability to dynamically open new ports the way that, for example, Chrome does when you open a new tab and connect to a new site. No matter how much data you&rsquo;re passing through the Tor network, it&rsquo;s all the same port &ndash; Firefox or the browser handle branching several simultaneous server connections down to one network port. And since it&rsquo;s one port, there can only be one circuit to the network open at once.</p>
                <p>Now, this can all be changed via configuration files &ndash; Tor is designed to be quite customizable so that the privacy fanatics can adapt to new bursts of paranoia on the fly. So the ugly, yet workable solution was simply to duplicate the Tor executable many times over, each pointing to a different torrc configuration file, each with a different pair of network ports. Getting this set up for the 20 instances I started with was tedious, becomes a real pain every time a Tor update is released, and I&rsquo;m sure there&rsquo;s a cleaner way to do it, but it works &ndash; multiple Tor instances can now be launched.</p>
                <p>The other side, Firefox, is a bit smoother. Here instead of copying the entire application, the profile system can be used. Each profile is named simply after the SOCKS port in use, to allow the name to easily be incremented as an integer in the launch code. After creating the profiles, they are simply manually configured to use the correct port to link to their corresponding Tor module. My RAM's screams of pain running 20 Tor browser and 20 Firefox windows at a time are tolerable.</p>
                
                <div class="pageimgcontainer"><img class="pageimg" src="/images/scrapeinaction.gif"></div>
                
                <p class="caption"><em>The absolute embodiement of "ugly but it works" in action. I've been told I need Jesus.</em></p>
                
                <p>The hardest part of all then became restarting everything. Previously, I was just indiscriminately killing any Tor and Firefox processes &ndash; if I was running either independent of the program, they would end up casualties. That was once an acceptable risk, but now, that would completely defeat the purpose of launching multiple Tor circuits: being able to stagger the restarts. Restarting is done by calling Runtime.exec(), which takes the argument and runs it as though it was entered in the windows command prompt. Passing &ldquo;taskkill /F /IM firefox.exe,&rdquo; as had been done previously, kills everything.</p>
                <p>Switching to Process IDs, unique ID numbers given by Windows to every running process, allowed individual processes to be targeted, but now the problem was identifying which was which. As mentioned, once a process is created it is not tracked, and to make matters worse, both Firefox and Tor are fairly &ldquo;messy&rdquo; applications, in that they create several processes during launch in ways which aren&rsquo;t quite consistent, and such that killing the initial process doesn&rsquo;t necessarily recursively kill its children. ...Wow, that sentence sounds psychopathic to people who aren't software developers, doesn't it? ...Anyways, this all means there&rsquo;s no good way to tell which processes are associated with which firefox modules just looking at the task manager.</p>
                <p>Currently, this is being solved by perhaps the most crude and unreliable technique in the whole program: listening. The selenium distributor contains a periodic method which scans the windows process list several times a second for instances of Firefox and Tor. It checks if it is already aware of each. If it is not, it associates the Process ID over to the most recently launched or relaunched Selenium module, creating a list of usually about 8 PIDs per module. When that module is commanded to restart, it kills all associated process IDs. That&rsquo;s it.</p>
                <p>It is not a good solution. It has no means of detecting the difference between processes launched by the java application, and by the user of the computer. It means that trying to restart multiple Tor instances together will result in chaos. It doesn&rsquo;t handle crashes gracefully. It means that manually closing Tor or Firefox will confuse it. It needs to be handled with care and treated delicately.</p> 

                <p>But it was enough to start doing useful things, and start to perform some real, large scale scrape operations with the data.</p>



                <div id="footer">
                    <div id=backbutton> 
                        <a class="nav" href="page2.html">                       <i class="far fa-arrow-alt-circle-left"></i>
                            <p class="arrowtext">Retreat!</p></a></div>
                    <div id=footerspacer></div>
                    <div id=nextbutton><a class="nav" href="page4.html">

                        <i class="far fa-arrow-alt-circle-right">
                        </i>
                        <p class="arrowtext">Onwards!</p></a>
                    </div>
                </div>




            </div>
        </div>




        <script>
            // When the user clicks on div, open the popup
            function myFunction() {
                var popup = document.getElementById("myPopup");
                popup.classList.toggle("show");
            }function myFunction2() {
                var popup = document.getElementById("myPopup2");
                popup.classList.toggle("show");
            }
            function hidePopups() 
            {
                console.log("Clicky");
                var popup = document.getElementsByClassName("show");
                for(var i = 0; i < popup.length; i++){
                    popup[i].classList.toggle("show");
                }
                popup = document.getElementsByClassName("popupmask");
                for(var i = 0; i < popup.length; i++){popup[i].classList.toggle("popupvisible");
                                                     }
            }
            function popup1() {
                var popup = document.getElementById("popup1");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }

            }
            function popup3() {
                var popup = document.getElementById("popup3");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup4() {
                var popup = document.getElementById("popup4");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup5() {
                var popup = document.getElementById("popup5");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup6() {
                var popup = document.getElementById("popup6");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup7() {
                var popup = document.getElementById("popup7");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup8() {
                var popup = document.getElementById("popup8");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup9() {
                var popup = document.getElementById("popup9");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup10() {
                var popup = document.getElementById("popup10");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup11() {
                var popup = document.getElementById("popup11");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup12() {
                var popup = document.getElementById("popup12");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup13() {
                var popup = document.getElementById("popup13");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup14() {
                var popup = document.getElementById("popup14");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup15() {
                var popup = document.getElementById("popup15");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup16() {
                var popup = document.getElementById("popup16");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup17() {
                var popup = document.getElementById("popup17");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup18() {
                var popup = document.getElementById("popup18");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup19() {
                var popup = document.getElementById("popup19");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup20() {
                var popup = document.getElementById("popup20");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup21() {
                var popup = document.getElementById("popup21");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup22() {
                var popup = document.getElementById("popup22");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup23() {
                var popup = document.getElementById("popup23");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup24() {
                var popup = document.getElementById("popup24");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup25() {
                var popup = document.getElementById("popup25");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup26() {
                var popup = document.getElementById("popup26");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup27() {
                var popup = document.getElementById("popup27");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup28() {
                var popup = document.getElementById("popup28");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup29() {
                var popup = document.getElementById("popup29");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup30() {
                var popup = document.getElementById("popup30");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup31() {
                var popup = document.getElementById("popup31");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup32() {
                var popup = document.getElementById("popup32");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup33() {
                var popup = document.getElementById("popup33");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup34() {
                var popup = document.getElementById("popup34");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup35() {
                var popup = document.getElementById("popup35");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup36() {
                var popup = document.getElementById("popup36");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup37() {
                var popup = document.getElementById("popup37");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup38() {
                var popup = document.getElementById("popup38");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup39() {
                var popup = document.getElementById("popup39");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup40() {
                var popup = document.getElementById("popup40");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup41() {
                var popup = document.getElementById("popup41");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup42() {
                var popup = document.getElementById("popup42");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
            function popup43() {
                var popup = document.getElementById("popup43");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup44() {
                var popup = document.getElementById("popup44");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup45() {
                var popup = document.getElementById("popup45");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup46() {
                var popup = document.getElementById("popup46");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup47() {
                var popup = document.getElementById("popup47");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup48() {
                var popup = document.getElementById("popup48");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup49() {
                var popup = document.getElementById("popup49");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
                        function popup50() {
                var popup = document.getElementById("popup50");
                popup.classList.toggle("show");
                var mask = document.getElementsByClassName("popupmask");
                for(var i = 0; i < mask.length; i++){
                    mask[i].classList.toggle("popupvisible");
                }
            }
        </script>
    </body>

</html>
